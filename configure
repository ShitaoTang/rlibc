#!/bin/sh

# é»˜è®¤å®‰è£…è·¯å¾„
prefix="/usr/local/rlibc"
includedir="$prefix/include"
debug="0"
target=""

ARCH = 

# è§£æžå‚æ•°
while [ $# -gt 0 ]; do
    case "$1" in
        --prefix=*)
            prefix="${1#*=}"
            ;;
        --enable-debug)
            debug="1"
            ;;
        --target=*)
            target="${1#*=}"
            ;;
        --help)
            echo "Usage: ./configure [--prefix=DIR] [--enable-debug] [--target=TRIPLE]"
            exit 0
            ;;
        *)
            echo "âŒ Unknown option: $1" >&2
            exit 1
            ;;
    esac
    shift
done

echo "ðŸ”§ Configuring rlibc..."
echo "ðŸ“ Install prefix: $prefix"
if [ "$debug" = "1" ]; then
    echo "ðŸž Debug mode: ENABLED"
else
    echo "ðŸš€ Debug mode: DISABLED"
fi
if [ -n "$target" ]; then
    echo "ðŸŽ¯ Target triple: $target"
else
    echo "âš ï¸ No target triple specified (default will be used by cargo)"
fi

# æ£€æµ‹æž¶æž„
arch=$(uname -m)
case "$arch" in
    x86_64) arch_macro="__x86_64__" ;;
    aarch64) arch_macro="__aarch64__" ;;
    *)
        echo "âŒ Unsupported architecture: $arch" >&2
        exit 1
        ;;
esac

# ç”Ÿæˆ specs æ–‡ä»¶
specs_dir="$prefix/lib"
specs_file="$specs_dir/rlibc-gcc.specs"
mkdir -p "$specs_dir" 2>/dev/null || {
    echo "âŒ Failed to create directory: $specs_dir" >&2
    exit 1
}

# å†™å…¥ config.mak ä¾› Makefile ä½¿ç”¨
if ! cat > config.mak <<EOF
prefix=$prefix
includedir=$includedir
ARCH=$arch
DEBUG=$debug
TARGET=$target
EOF
then
    echo "âŒ Failed to write config.mak" >&2
    exit 1
fi

echo "âœ… Generated config.mak"

# å®‰è£… rlibc-gcc è„šæœ¬
bin_dir="$prefix/bin"
wrapper_path="$bin_dir/rlibc-gcc"
mkdir -p "$bin_dir" 2>/dev/null || {
    echo "âŒ Failed to create directory: $bin_dir" >&2
    exit 1
}

if ! cat > "$wrapper_path" <<EOF
#!/bin/sh
exec \${REALGCC:-gcc} "\$@" -specs "$specs_file"
EOF
then
    echo "âŒ Failed to install rlibc-gcc to $wrapper_path" >&2
    exit 1
fi

if ! chmod +x "$wrapper_path"; then
    echo "âŒ Failed to make rlibc-gcc executable at $wrapper_path" >&2
    exit 1
fi

echo "âœ… Installed rlibc-gcc wrapper at $wrapper_path"

echo "ðŸŽ‰ Configuration complete. Run 'make && make install'"